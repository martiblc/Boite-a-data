---
title: "scripts_pratiques"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = FALSE, include = TRUE)
```

# Scripts pratiques

## üìÇ Import

-   [Importer fichier excel et joindre toutes les feuilles avec un identifiant](https://dominicroye.github.io/en/2019/import-excel-sheets-with-r/)

```{r}
lien <- ("C:/Users/user/Documents/0_PRO/Data et scripts/NOMDUFICHIER.xlsx")

df <- lien %>%
  excel_sheets()%>%
  set_names() %>%
  map_df(read_excel, path = lien, .id = "nomfuturecolonneidentifiant")
```

## üßπ Nettoyage

-   √âliminer les doublons sur toute la ligne ou bas√© sur une colonne

```{r}

# Exclure les doublons
df %>% distinct(col1, col2, col3, .keep_all = T)

# Garder que les doublons
df %>% group_by(col1, col2, col3) %>% filter(n() > 1)

# Filtrer les doublons
df %>% group_by(col1, col2, col3) %>% filter(n() == 1)

# M√©thode de base pour exclure les doublons
df[!duplicated(df[1:3]), ]
df[!duplicated(df[c("col1", "col2"), ]), ]
```

-   Retirer tous les accents, c√©dilles...

```{r}
mutate(colonne = iconv(colonne, from="UTF-8",to="ASCII//TRANSLIT"))
```

-   Utiliser mutate_at pour appliquer facilement fonction et remplacer valeurs

```{r}
# Exemple 1
df %>% mutate_at("var1", ~str_replace_all(., " ", "<br>"))

# Exemple 2
df %>% mutate_at("var2", ~replace(., is.nan(.), 0))
```

-   E

```{r}

```

## üõ† Wrangling

### Calculs

-   Calcul glissant (moyenne, somme,...)

```{r}
# Moyenne glissante sur 7 jours
slider::slide_dbl(n_dose1, sum, .before=6, .complete = TRUE) / 7
```

-   Normaliser/standardiser une s√©rie afin d'obtenir une note pour chaque valeur respectant les √©carts

```{r}
note_max_meilleur <- function(x) {
(x - min(x)) / (max(x) - min(x))
}

note_min_meilleur <- function(x) {
(x - max(x)) / (min(x) - max(x))
}
```

### Travail en largeur

-   Appliquer m√™me fonction sur tout un rang de colonnes (utilisable avec group_by)

```{r}
df %>% group_by(colonne_groupe) %>%
  summarise(across(1e_col_choisie:derniere_col_choisie, mean))

# Utiliser tilde avec fonction pour changer ses arguments
df %>% group_by(colonne_groupe) %>%
  summarise(across(1e_col_choisie:derniere_col_choisie, ~ mean(.x, na.rm = TRUE)))
```

-   Appliquer une fonction ou calcul en largeur (sur la ligne / rowwise)

```{r}
df %>%
  rowwise() %>%
  mutate(nouvelle_col = sum(c_across(1e_col_choisie:derniere_col_choisie)) / 4)
```

### Fonctions maison

-   Sauvegarder r√©sultat fonction dans environnement global R (√† utiliser dans fonction par exemple)

```{r}
assign(x = nom_objet, value = objet, envir = .GlobalEnv)
```

### Filtrer

-   Filtrer valeurs qui contiennent caract√®res XYZ

```{r}
filter(grepl("CARACTERESXYZ", colonne_a_filtrer))
```

-   [Filtrer dans plusieurs variables](https://dplyr.tidyverse.org/reference/filter_all.html#arguments)
    -   if_any() si la condition doit √™tre remplie dans une seule des variables au moins
    -   if_all() si elle doit l'√™tre dans toutes les variables

Les deux se basent sur une fonction pour filter. Il faut donc l'introduire avec le tilde. Le .x avant un op√©rateur est n√©cessaire pour lui introduire chacune des variables que va it√©rer le everything() ou across().

```{r}
filter(if_any(everything(), ~ .x == "Poor" ))

# everything() pour s√©lectionner toutes les variables
# across() pour s√©lectionner une plage

filter(across(quality2018:quality2021, ~ !is.na(.x)))
```

### Divers

-   Changer valeurs d'une ou plusieurs variables avec recode

```{r}
# Changer valeurs d'une variable
mutate(col1 = recode(col1, 
                         `valeur1` = "val_1.1",
                         `valeur2` = "val_2.1"))

# Changer valeurs dans plusieurs variables 
mutate_at(c("col1","col2"), 
          list(~ recode(., valeur1 = "val_1.1",
                         valeur2 = "val_2.1",
                         .default = NaN))) 
```

-   Changer valeurs d'une variable avec une ou plusieurs conditions avec case_when

```{r}
# Utilisation classique avec case_when
df %>% 
  mutate_at("col1",funs(
    case_when(col1 == 1 ~ "alt1",
              col1 == 2 ~ "alt2",
              T ~ "alt3")))


# Utilisation case_when avec between (rang num√©rique)
df %>% 
  mutate(col1 = case_when(
      between(var2, 1, 5) ~ "A",
      between(var2, 6, 10) ~ "B",
      T ~ col1)
      )
```

## RegEx

Utiliser str_detect avec filter - str_detect(df,"\^F")) -\> commence par F - "F\$" -\> finit par F - "\\d" -\> contient des chiffres - ! -\> plac√© devant str_detect comme argument "SAUF"

Utiliser aussi if_any, ends_with et starts_with

## Divers

```{r}
deces_2015_clean <- deces_2015_clean %>%
  mutate_if(is.character, str_squish)
```

## Viz

-   Enregistrer png

```{r}
ggsave(filename = "NOMDUFICHIER.png", width=18, height = 13, units = "cm",type="cairo-png")
```

-   Utiliser subset pour filtrer

```{r}
geom_bar(data = subset(vaccins_natio, vaccin != 0))
```

-   Marges

```{r}
theme(plot.margin = margin(5, 5, 5, 5, "mm"))
```

-   L√©gende en haut √† droite dans le graph

```{r}
theme(legend.position = c(0, 1), 
legend.justification = c(-0.1, 1.1))
```

-   Supprimer titre l√©gende

```{r}
theme(legend.title=element_blank())
```

-   Lmite date d√©but axe x

```{r}
scale_x_date(limits = c(ymd("2021-01-01"), NA))
```

-   Placer texte axe x en biais

```{r}
theme(axis.text.x = element_text(angle = 45, hjust=1))
```

-   Formater labels avec , en d√©cimal et . s√©parateur centaines

```{r}
scale_y_continuous(labels=function(x) format(x, big.mark = ".", decimal.mark = ",", scientific = FALSE))
```
